\section{CGazHUD}
\label{sec:cgazhud}
\cite{injx_physics}\\
Short for CampingGaz-HUD.

\subsection{Strafing on flat ground or in air}
\label{sec:normal_strafe}
When we try to apply an acceleration $\vec{\flat{a}}$ at some angle $\delta$ to the velocity $\vec{\flat{v}}_f$, we will be allowed to accelerate provided that the component of our current velocity in the proposed direction is smaller than $s$, also expressed as $\flat{v}_f \cos\delta < s$. The size of the acceleration applied, $\flat{a}$, is a constant\footnote{In the air $\flat{a} = 2.56$, while on the ground $\flat{a} = 25.6$ and $\flat{a} = 38.4$ for VQ3 and CPM, respectively.}, independent of the angle at which it is applied. However, there is one special case which is an exception to this rule. If $\flat{v}_f \cos\delta < s$ but still very close to $s$, applying the usual constant acceleration $\flat{a}$ for a single frame would be enough to take you over $s$ in that direction. This is something the engine checks for, and if the situation exists, the applied acceleration will be only enough to take you up to $s$ (so the resulting acceleration would be $s - \flat{v}_f \cos\delta$ instead of the full acceleration $\flat{a}$). However, the range of angle $\delta$ at which this situation exists is very small ($\delta_{\min} \le \delta \le \delta_{\opt}$) as can be seen in Figure \ref{fig:delta_min_friction}--\ref{fig:delta_opt_friction}.
\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.33\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_min_friction}
		\caption{}
		\label{fig:delta_min_friction}
	\end{subfigure}%
	\begin{subfigure}[t]{.33\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_opt_friction}
		\caption{}
		\label{fig:delta_opt_friction}
	\end{subfigure}%
	\begin{subfigure}[t]{.33\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_max_friction}
		\caption{}
		\label{fig:delta_max_friction}
	\end{subfigure}
	\caption{The current velocity $\vec{\flat{v}}$ (\yellowdenselydottedarrow) and the velocity after friction $\vec{\flat{v}}_f$ (\yellowarrow) together with all possible acceleration configurations (\lightorangearea).}
	%	\label{fig:delta}
\end{figure}
Hence, we can summarize that
\begin{align}
\label{eq:r}
\vec{\flat{r}} &=
\begin{cases}
\vec{\flat{v}}_f, & s - \flat{v}_f \cos\delta \le 0,\\
\vec{\flat{v}}_f + (s - \flat{v}_f \cos\delta)\uvec{\flat{a}}, & 0 < s - \flat{v}_f \cos\delta \le \flat{a},\\
\vec{\flat{v}}_f + \mathmakebox[\widthof{$(s - \flat{v}_f \cos\delta)$}][r]{\flat{a}} \uvec{\flat{a}}, & s - \flat{v}_f \cos\delta > \flat{a}.
\end{cases}
\end{align}

The acceleration causes a change in the total velocity, which is made up of a \emph{change in speed} and a \emph{change in direction}. The direction $\uvec{a}$ in which the acceleration is applied dictates how much of this acceleration goes into changing the speed, and how much goes into changing the direction. In \emph{strafe-jumping}, it is the \emph{change in speed} we are interested in \emph{maximizing}, in an increasing fashion.

The way to achieve this maximum increase in speed is by applying the acceleration so its direction is as close to that of the original velocity as possible, i.e. so the angle $\delta$ is as small as possible. This will mean that more of the acceleration goes into increasing our speed, and less goes into affecting the direction. The limiting condition gives a minimum angle of
\begin{align}
\label{eq:delta_min}
\delta_{\min} &= \acos\left(\frac{\sqrt{s^2 - \flat{v}^2 + \flat{v}_f^2}}{\flat{v}_f} \right).
\end{align}
However, in order to gain the full acceleration, $\flat{a}$, we need the angle to be a bit larger, so we avoid the special case mentioned above. Therefore the optimal angle is the smallest angle at which we receive the full acceleration, $\flat{a}$, which is given by
\begin{align}
\label{eq:delta_opt}
\delta_{\opt} &= \acos\left( \frac{s - \flat{a}}{\flat{v}_f} \right).
\end{align}
As you can see, this optimal angle depends on the current velocity $\flat{v}_f$ and increases towards \ang{90} as the velocity goes to infinity. The other limiting condition (i.e. the maximum angle), shown in Figure \ref{fig:delta_max_air}, is given by
\begin{align}
\label{eq:delta_max}
\delta_{\max} &= \acos\left( \frac{\flat{v}^2 - \flat{v}_f^2 - \flat{a}^2}{2 \flat{a} \flat{v}_f} \right).
\end{align}
Hence, the angles $\delta_{\min}$ and $\delta_{\max}$ represent the boundaries between a speed increase and possible speed decrease. When $\vec{\flat{v}} = \vec{\flat{v}}_f$, e.g. in the air\footnote{In the air there is no friction ($c = 0$).}, equations \eqref{eq:delta_min} and \eqref{eq:delta_max} simplify to respectively
\begin{align}
\label{eq:delta_min_vf}
\delta_{\min} &= \acos\left( \frac{s}{\flat{v}_f} \right),\\
\label{eq:delta_max_vf}
\delta_{\max} &= \acos\left( -\frac{a}{2 \flat{v}} \right).
\end{align}
Note that, in the air, $\delta_{\max}$ exceeds \ang{90} and still results in a speed increase. On the ground, the angles $\delta_{\min}$, $\delta_{\opt}$ and $\delta_{\max}$ will eventually meet when we reach the \emph{maximum ground speed}\footnote{When we introduce velocity snapping (Section \ref{sec:snaphud}), this is no longer the maximum ground speed.}, due to the friction ($c = 6$), shown in Figure \ref{fig:v_ground} (top left magnification). The mathematically derivation is done in Appendix \ref{app:derive_flat_v_max} and results in
\begin{align}
\label{eq:flat_v_max}
\flat{v}_{\max} &= s \sqrt{\frac{A (2 - AT)}{c (2 - cT)}}.
\end{align}
Knowing this, we find that on a flat surface the maximum ground speed for $\text{VQ3} = \qty{409.7180}{ups}$ and $\text{CPM} = \qty{496.5454}{ups}$, at $\qty{125}{fps}$. Note that if there is no friction ($c = 0$), there would in principle be no limit on the maximum speed. This would be an example of being on an icy surface, or in the air. However there are inevitably other aspects of the engine that put limits on very high speeds.

%Figure \ref{fig:delta_phi}, law of cosines
%\begin{align*}
%a^2 &= r^2 + v_f^2 - 2r v_f\cos\varphi,\\
%\cos\varphi &= \frac{r^2 + v_f^2 - a^2}{2r v_f}.
%\end{align*}

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_min_air}
		\caption{}
		\label{fig:delta_min_air}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_air}
		\caption{}
		\label{fig:delta_air}
	\end{subfigure}
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_opt_air}
		\caption{}
		\label{fig:delta_opt_air}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/delta_max_air}
		\caption{}
		\label{fig:delta_max_air}
	\end{subfigure}
	\caption{In the air ($\vec{\flat{v}} = \vec{\flat{v}}_f$). The current velocity $\vec{\flat{v}}$ (\yellowarrow) together with all possible acceleration configurations (\lightorangearea).}
%	\label{fig:delta_air}
\end{figure}

At this point, it might be interesting to define the $\delta$-region where you gain speed in the direction of the current velocity $\uvec{\flat{v}}$. Similar to equation \eqref{eq:delta_min}, we derive the point where we first start gaining speed in the direction $\uvec{\flat{v}}$. The limiting condition gives a minimum angle of
\begin{align}
\label{eq:delta_bar_min}
\bar{\delta}_{\min} &= \acos\left( \frac{s + \sqrt{s^2 - 4 \flat{v}_f (\flat{v} - \flat{v}_f)}}{2 \flat{v}_f} \right).
\end{align}
Similar to equation \eqref{eq:delta_max}, we derive the point where we stop gaining speed in the direction $\uvec{\flat{v}}$. The limiting condition gives a maximum angle of
\begin{align}
\label{eq:delta_bar_max}
\bar{\delta}_{\max} &= \acos\left( \frac{\flat{v} - \flat{v}_f}{\flat{a}} \right).
\end{align}
Hence, the angles $\bar{\delta}_{\min}$ and $\bar{\delta}_{\max}$ represent the boundaries between a speed increase and a speed decrease in the direction of the current velocity $\uvec{\flat{v}}$. Similar as before, when $\vec{\flat{v}} = \vec{\flat{v}}_f$ (e.g. in the air), equations \eqref{eq:delta_bar_min} and \eqref{eq:delta_bar_max} simplify to
\begin{align}
\label{eq:delta_bar_min_vf}
\bar{\delta}_{\min} &= \acos\left( \frac{s}{\flat{v}_f} \right) = \eqref{eq:delta_min_vf},\\
\label{eq:delta_bar_max_vf}
\bar{\delta}_{\max} &= \frac{\pi}{2}.
\end{align}
Knowing all these angles, we can create a CGazHUD (i.e. a strafe-jump helper), which is divided in 5 regions (see Figure \ref{fig:v_air} and \ref{fig:v_ground}):
\begin{itemize}
	\item[\textcolor{cgazgrey!50}{$\blacksquare$}] $\delta \in [0, \delta_{\min})$\\
	The no-acceleration zone.
	\item[\textcolor{cgazgreen!50}{$\blacksquare$}] $\delta \in [\delta_{\min}, \delta_{\opt})$\\
	The zone where we do not get the full acceleration $\flat{a}$ yet, as described above. Note that it is not desired for a human to stay inside this zone.
	\item[\textcolor{cgazdarkgreen!50}{$\blacksquare$}] $\delta \in [\delta_{\opt}, \bar{\delta}_{\max})$\\
	The main acceleration zone. Stay for the most part inside this zone, preferably close to the edge between the two green zones to keep the \emph{change in direction} minimal.
	\item[\textcolor{cgazyellow!50}{$\blacksquare$}] $\delta \in [\bar{\delta}_{\max}, \delta_{\max}]$\\
	The turn zone where we no longer gain speed in the direction of the current velocity $\uvec{\flat{v}}$, however the overall speed increases.
	\item[$\square$] $\delta \in (\delta_{\max}, \pi]$\\
	The deceleration zone.
\end{itemize}

\begin{figure}[H]
	\centering
	\setlength\figureheight{4.8cm}
	\setlength\figurewidth{13cm}
	\includetikz{tikz/v_air}
%	\vspace*{-2.5mm}
	\caption{Numerical example in the air with an initial velocity $\vec{v} = \inlinemat{400, 0, 0}^T$. Magnification $\times30$. CGazHUD boundaries: $0 ~\highlightcgazgrey{\le}~ \delta_{\min}^{\eqref{eq:delta_min_vf}} ~\highlightcgazgreen{\le}~ \delta_{\opt}^{\eqref{eq:delta_opt}} ~\highlightcgazdarkgreen{\le}~ \bar{\delta}_{\max}^{\eqref{eq:delta_bar_max_vf}} ~\highlightcgazyellow{\le}~ \delta_{\max}^{\eqref{eq:delta_max_vf}} \le \pi$.}
	\label{fig:v_air}
\end{figure}
\begin{figure}[H]
	\centering
	\setlength\figureheight{4.8cm}
	\setlength\figurewidth{13cm}
	\includetikz{tikz/v_ground}
	\caption{Numerical example on the ground with an initial velocity $\vec{v} = \inlinemat{400, 0, 0}^T$. Magnification $\times10$. Upper CGazHUD boundaries: $0 ~\highlightcgazgrey{\le}~ \delta_{\min}^{\eqref{eq:delta_min}} ~\highlightcgazgreen{\le}~ \delta_{\opt}^{\eqref{eq:delta_opt}} ~\highlightcgazdarkgreen{\le}~ \bar{\delta}_{\max}^{\eqref{eq:delta_bar_max}} ~\highlightcgazyellow{\le}~ \delta_{\max}^{\eqref{eq:delta_max}} \le \pi$; lower CGazHUD boundaries: $0 ~\highlightcgazgrey{\le}~ \delta_{\min}^{\eqref{eq:delta_min_vf}} ~\highlightcgazgreen{\le}~ \delta_{\opt}^{^{\eqref{eq:delta_opt}}} ~\highlightcgazdarkgreen{\le}~ \bar{\delta}_{\max}^{\eqref{eq:delta_bar_max_vf}} ~\highlightcgazyellow{\le}~ \delta_{\max}^{\eqref{eq:delta_max_vf}} \le \pi$.}
	\label{fig:v_ground}
\end{figure}

\subsection{Influence of movement keys}
\label{sec:movementkeys}
\begin{align*}
\vec{\cmd} =
\begin{pmatrix}
\fmove \\ \rmove \\ \umove
\end{pmatrix}, \qquad \vec{\flat{\cmd}} =
\begin{pmatrix}
\fmove \\ \rmove \\ 0
\end{pmatrix},
\end{align*}
The direction of acceleration $\uvec{\flat{a}}$ \eqref{eq:accel_direction} can be chosen by using your mouse and the movement keys. Relative to $\nu = \atan\left(\frac{v_y}{v_x}\right)$
\begin{align*}
\uvec{\flat{v}} = \frac{1}{\flat{v}}
\begin{pmatrix}
v_x \\ v_y \\ 0
\end{pmatrix}
\end{align*}

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/cmd}
		\caption{}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\setlength\figureheight{5.5cm}
		\setlength\figurewidth{5.5cm}
		\includetikz{tikz/cmd3d} % TODO: merge cmd3d_2
		\caption{}
	\end{subfigure}%
	\caption{The current velocity $\vec{\flat{v}}_f$ (\yellowarrow), the acceleration $\vec{a}$ (\orangearrow) and the resulting new velocity $\vec{\flat{r}}$ (\bluearrow). (a) is the top view of (b). key plane (\lightorangearea)}
	\label{fig:cmd}
\end{figure}

% TODO: make projections of 2 vs 1 key combinations

where $\gamma = \delta + \nu$ represents the yaw angle.

Appendix \ref{app:angle_vectors}

The current velocity vector is defined as
\begin{align*}
\uvec{\fmove} &=
\begin{pmatrix}
	\cos\rho\cos\gamma\\
	\cos\rho\sin\gamma\\
	-\sin\rho
\end{pmatrix},\\
\uvec{\rmove} &=
\begin{pmatrix}
	-\sin\sigma\sin\rho\cos\gamma + \cos\sigma\sin\gamma\\
	-\sin\sigma\sin\rho\sin\gamma - \cos\sigma\cos\gamma\\
	-\sin\sigma\cos\rho
\end{pmatrix},\\
\uvec{\umove} &=
\begin{pmatrix}
	\cos\sigma\sin\rho\cos\gamma + \sin\sigma\sin\gamma\\
	\cos\sigma\sin\rho\sin\gamma - \sin\sigma\cos\gamma\\
	\cos\sigma\cos\rho
\end{pmatrix},
\end{align*}

\codeFromFile{firstline=621,lastline=625,gobble=1}{code/game/bg_pmove.c}

\begin{align*}
\uvec{\flat{\fmove}} &=
\begin{pmatrix}
	\cos\rho\cos\gamma\\
	\cos\rho\sin\gamma\\
	0
\end{pmatrix} \frac{1}{\sqrt{\cos^2\rho}} =
\begin{pmatrix}
	\cos\gamma\\
	\sin\gamma\\
	0
\end{pmatrix},\\
\uvec{\flat{\rmove}} &=
\begin{pmatrix}
	-\sin\sigma\sin\rho\cos\gamma + \cos\sigma\sin\gamma\\
	-\sin\sigma\sin\rho\sin\gamma - \cos\sigma\cos\gamma\\
	0
\end{pmatrix} \frac{1}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}},
\end{align*}

\begin{align*}
\uvec{\flat{\fmove}}^T \uvec{\flat{\rmove}} &= \frac{-\sin\sigma\sin\rho\cos^2\gamma + \cos\sigma\sin\gamma\cos\gamma - \sin\sigma\sin\rho\sin^2\gamma - \cos\sigma\sin\gamma\cos\gamma}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}}\\
&= \frac{-\sin\sigma\sin\rho}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}}
\end{align*}

\begin{align*}
\vec{\flat{\fmove}} + \vec{\flat{\rmove}} = \texttt{wishvel} &= \fmove
\begin{pmatrix}
	\cos\gamma\\
	\sin\gamma\\
	0
\end{pmatrix} + \rmove
\begin{pmatrix}
	-\sin\sigma\sin\rho\cos\gamma + \cos\sigma\sin\gamma\\
	-\sin\sigma\sin\rho\sin\gamma - \cos\sigma\cos\gamma\\
	0
\end{pmatrix} \frac{1}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}},
\end{align*}

\begin{align*}
\norm{\vec{\flat{\fmove}} + \vec{\flat{\rmove}}}^2 = \norm{\texttt{wishvel}}^2 = &\fmove^2 \cos^2\gamma + \rmove^2 \frac{\sin^2\sigma\sin^2\rho\cos^2\gamma + \cos^2\sigma\sin^2\gamma - \sin\sigma\cos\sigma\sin\rho\sin\gamma\cos\gamma}{\sin^2\sigma\sin^2\rho + \cos^2\sigma} +\\
&\fmove^2 \sin^2\gamma + \rmove^2 \frac{\sin^2\sigma\sin^2\rho\sin^2\gamma + \cos^2\sigma\cos^2\gamma + \sin\sigma\cos\sigma\sin\rho\sin\gamma\cos\gamma}{\sin^2\sigma\sin^2\rho + \cos^2\sigma} +\\
&2\fmove\rmove\frac{-\sin\sigma\sin\rho\cos^2\gamma + \cos\sigma\sin\gamma\cos\gamma}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}} +\\
&2\fmove\rmove\frac{-\sin\sigma\sin\rho\sin^2\gamma - \cos\sigma\sin\gamma\cos\gamma}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}},\\
%
= &\fmove^2 + \rmove^2 + 2\fmove\rmove\frac{-\sin\sigma\sin\rho}{\sqrt{\sin^2\sigma\sin^2\rho + \cos^2\sigma}},
\end{align*}

Derivative
\begin{align*}
\frac{\mathrm{d}}{\mathrm{d}\rho} \norm{\vec{\flat{\fmove}} + \vec{\flat{\rmove}}}^2 = \frac{\mathrm{d}}{\mathrm{d}\rho} \norm{\texttt{wishvel}}^2 = 2\fmove\rmove\frac{-\sin\sigma\cos^2\sigma\cos\rho}{\left( \sin^2\sigma\sin^2\rho + \cos^2\sigma \right)^{3/2}},
\end{align*}
This is $0$ when
\[
\begin{cases}
	\rho = \hphantom{-}\frac{\pi}{2} + 2k\pi, &k \in \mathbb{N},\\
	\rho = -\frac{\pi}{2} + 2k\pi, &k \in \mathbb{N}.
\end{cases}
\]

With optimal $\rho$ filled in, we get
\begin{align*}
\uvec{\flat{\fmove}}^T \uvec{\flat{\rmove}} &= -\sin\sigma,\\
&= \sin\sigma,
\end{align*}
\begin{align*}
\norm{\vec{\flat{\fmove}} + \vec{\flat{\rmove}}}^2 = \norm{\texttt{wishvel}}^2 &= \fmove^2 + \rmove^2 - 2\fmove\rmove\sin\sigma,\\
&= \fmove^2 + \rmove^2 + 2\fmove\rmove\sin\sigma,
\end{align*}

Appendix \ref{app:cmd_scale}

\begin{align*}
\texttt{scale} = \frac{\texttt{speed}\norm{\vec{\cmd}}_{\infty}}{127\norm{\vec{\cmd}}},
\end{align*}

\begin{align*}
\texttt{wishspeed} &= \texttt{scale} \norm{\texttt{wishvel}} =
\frac{\texttt{speed}\norm{\vec{\cmd}}_{\infty}}{127\norm{\vec{\cmd}}} \norm{\texttt{wishvel}},\\
\norm{\vec{\flat{a}}} &= \flat{a} = AT \texttt{wishspeed} = AT\frac{\texttt{speed}\norm{\vec{\cmd}}_{\infty}}{127\norm{\vec{\cmd}}} \norm{\texttt{wishvel}},
\end{align*}
when $\fmove = 127$, $\rmove = 0$ and $\umove = 0$, then $s = 320$ like in the previous section.

Air:
\begin{align}
\nonumber
\norm{\projmat{a} \vec{\flat{v}}_f} + \norm{\vec{\flat{a}}} &= s \norm{\uvec{\flat{a}}},\\
\nonumber
\vec{v}_{f}^T\texttt{wishdir} + \texttt{accel}T\texttt{wishspeed} &= \texttt{wishspeed}\norm{wishdir},\\
\nonumber
\norm{\vec{\flat{v}}_f} \cos{\delta_{\opt}} + \texttt{accel}T\texttt{wishspeed} &= \texttt{wishspeed},\\
\nonumber
\flat{v}_f \cos{\delta_{\opt}} &= \texttt{wishspeed} - \texttt{accel}T\texttt{wishspeed},\\
\delta_{\opt} &= \acos\left( \frac{\texttt{wishspeed} \left(1 - \texttt{accel}T\right)}{\flat{v}_f} \right).
\end{align}

\texttt{PM\_Accelerate (wishdir, wishspeed, pm\_airaccelerate);}

The strafe keys in CPM do not ever affect upmove. Not true


\subsection{Strafing on icy surfaces}
\label{sec:icy}
Acceleration $a = 1$ on a icy surface is identical to the acceleration in the air, however, this is not the entire story. Every frame Gravity $g = 800$ (\texttt{g\_gravity}).
\begin{align*}
v_{f_3} - gT
\end{align*}

Explain the drifting speed and sticky jump overbounces (graph time for ob with respect to your current velocity, slick top view turn (with(out) jump)).


\subsection{Strafing on sloped surfaces}
\begin{align*}
\vec{n} &=
\begin{pmatrix}
n_1\\n_2\\n_3
\end{pmatrix}, & \vec{k} &=
\begin{pmatrix}
0\\0\\1
\end{pmatrix},\\
\vec{\flat{n}} &=
\begin{pmatrix}
0\\0\\1
\end{pmatrix}, &
\vec{\bar{k}} &=
\begin{pmatrix}
-n_1\\-n_2\\\hphantom{-}n_3
\end{pmatrix},\\
%
\mat{P}_{\perp \vec{n} \rightarrow \vec{n}} = \mat{I} - \vec{n}\vec{n}^T &=
\begin{pmatrix}
n_2^2+n_3^2 & -n_1 n_2 & -n_1 n_3\\
-n_1 n_2 & n_1^2+n_3^2 & -n_2 n_3\\
-n_1 n_3 & -n_2 n_3 & n_1^2+n_2^2
\end{pmatrix},\\
\mat{P}_{\perp \vec{n} \rightarrow \vec{k}} = \mat{I} - \frac{\vec{n}\vec{k}^T}{\vec{n}^T\vec{k}} &=
\begin{pmatrix}
1 & 0 & -\frac{n_1}{n_3}\\
0 & 1 & -\frac{n_2}{n_3}\\
0 & 0 & \hphantom{-}0
\end{pmatrix},\\
\mat{P}_{\perp \vec{k} \rightarrow \vec{\bar{k}}} = \mat{I} - \frac{\vec{k}\vec{\bar{k}}^T}{\vec{k}^T\vec{\bar{k}}} &=
\begin{pmatrix}
1 & 0 & 0\\
0 & 1 & 0\\
\frac{n_1}{n_3} & \frac{n_2}{n_3} & 0
\end{pmatrix},
\end{align*}

\begin{align*}
% no slope
\yaw_1 &= -\arctan\frac{n_1}{n_2},\\
% min angle yaw1 - yaw2
\yaw_2 &= -\arctan\frac{n_1}{n_2} + \frac{\pi}{2},\\
% no slope
\yaw_3 &= -\arctan\frac{n_1}{n_2} + \pi,\\
% max angle yaw2 - yaw1
\yaw_4 &= -\arctan\frac{n_1}{n_2} - \frac{\pi}{2},
\end{align*}

It is this acceleration, provided by the movement keys, which gives the player a change in velocity, which ultimately changes his position.
\begin{align*}
\flat{\fmove} &=
\begin{pmatrix}
\cos(\delta+\yaw_4) \\ \sin(\delta+\yaw_4) \\ 0
\end{pmatrix} = \frac{1}{\sqrt{n_1^2 + n_2^2}}
\begin{pmatrix}
\hphantom{-}n_2\sin\delta - n_1\cos\delta\\
-n_1\sin\delta - n_2\cos\delta\\
0
\end{pmatrix},
\end{align*}

One can use the \emph{Rodrigues' rotation formula} to construct the rotation matrix $\mat{R}$ that rotates by an angle $\phi = \arccos(\vec{k}^T\vec{n})$ about the unit vector (\purplearrow)
\begin{equation}
\label{eq:u}
\vec{u} =
\begin{pmatrix}
u_1\\u_2\\u_3
\end{pmatrix} = \frac{1}{\sqrt{n_1^2 + n_2^2}}
\begin{pmatrix}
-n_2\\\hphantom{-}n_1\\\hphantom{-}0
\end{pmatrix}.
\end{equation}
Letting
\[
\mat{W} =
\begin{pmatrix}
\hphantom{-}0 & -u_3 & \hphantom{-}u_2\\
\hphantom{-}u_3 & \hphantom{-}0 & -u_1\\
-u_2 & \hphantom{-}u_1 & \hphantom{-}0
\end{pmatrix},
\]
the Rodrigues' rotation matrix is constructed as
\begin{align*}
\mat{R} &= \mat{I} + \sin \phi \mat{W} + 2\sin^2 \frac{\phi}{2}\mat{W}^2,\\
\mat{R} &= \mat{I} + \sqrt{n_1^2 + n_2^2}\mat{W} + (1 - n_3)\mat{W}^2,\\
\mat{R} &=
\begin{pmatrix}
\frac{n_3 n_1^2 + n_2^2}{n_1^2 + n_2^2} & \frac{n_1 n_2 (n_3 - 1)}{n_1^2 + n_2^2} & n_1\\
\frac{n_1 n_2 (n_3 - 1)}{n_1^2 + n_2^2} & \frac{n_1^2 + n_3 n_2^2}{n_1^2 + n_2^2} & n_2\\
-n_1 & -n_2 & n_3
\end{pmatrix}.
\end{align*}

\begin{align*}
S2F &=
\begin{pmatrix}
\frac{n_3 n_1^2 + n_2^2}{n_1^2 + n_2^2} & \frac{n_1 n_2 (n_3 - 1)}{n_1^2 + n_2^2} & -n_1\\
\frac{n_1 n_2 (n_3 - 1)}{n_1^2 + n_2^2} & \frac{n_1^2 + n_3 n_2^2}{n_1^2 + n_2^2} & -n_2\\
n_1 & n_2 & \hphantom{-}n_3
\end{pmatrix}\\
currentspeed &= S2F velocity;
\end{align*}

\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{\textwidth}
		\centering
		\begin{subfigure}[t]{0.5\textwidth}
			\centering
			\setlength\figureheight{6.5cm}
			\setlength\figurewidth{6.5cm}
			\includetikz{tikz/define}
		\end{subfigure}%
		\begin{subfigure}[t]{0.5\textwidth}
			\centering
			\setlength\figureheight{5cm}
			\setlength\figurewidth{5cm}
			\includetikz{tikz/define2}
		\end{subfigure}
		\caption{}
	\end{subfigure}
	\begin{subfigure}[t]{\textwidth}
		\centering
		\begin{subfigure}[t]{0.5\textwidth}
			\centering
			\setlength\figureheight{6.5cm}
			\setlength\figurewidth{6.5cm}
			\includetikz{tikz/defineT}
		\end{subfigure}%
		\begin{subfigure}[t]{0.5\textwidth}
			\centering
			\setlength\figureheight{5cm}
			\setlength\figurewidth{5cm}
			\includetikz{tikz/defineT2}
		\end{subfigure}
		\caption{}
	\end{subfigure}
	\caption{The unit vector $\uvec{u}$ (\purplearrow) from equation \eqref{eq:u}. (a) Original setup: the key plane (\orangearea) and the surface (\greenarea). (b) Change of basis, with the surface normal $\vec{\flat{n}}$ (\greenarrow) straight up.}
\end{figure}


\subsection{CPM air control}
\label{sec:turnCPM}
Forwardkey aircontrol, forwardkey CGazHUD strafing, forwardkey side speed gain

Sidestrafe aircontrol applies regular acceleration with an additional change of direction. The new velocity is pulled towards the yaw angle.


\subsection{Swimming and flying}
After friction is applied, the current velocity vector becomes
\begin{align*}
\vec{v}_f &=
\begin{pmatrix}
v_{fx} \\ v_{fy} \\ v_{fz}
\end{pmatrix} = \norm{\vec{v}_f} \uvec{v} = (1-cT)\vec{v},
\end{align*}
with a magnitude
\begin{align*}
%\label{eq:vf}
\norm{\vec{v}_f} &= \sqrt{\vec{v}_f^T \vec{v}_f} = \sqrt{v_{fx}^2 + v_{fy}^2 + v_{fz}^2} = v_f = (1-cT)v,
\end{align*}
with $c = 3$ the friction factor when using flight (\texttt{pm\_flightfriction}).

\begin{align*}
\vec{\fmove} &= \norm{\vec{\fmove}} \uvec{\fmove} = \fmove
\begin{pmatrix}
\cos\rho\cos\gamma \\ \cos\rho\sin\gamma \\ -\sin\rho
\end{pmatrix},\\
%
\vec{\rmove} &= \norm{\vec{\rmove}} \uvec{\rmove} = \rmove
\begin{pmatrix}
\hphantom{-}\sin\gamma \\ -\cos\gamma \\ 0
\end{pmatrix},\\
%
\vec{\umove} &= \norm{\vec{\umove}} \uvec{\umove} = \umove
\begin{pmatrix}
\sin\rho\cos\gamma \\ \sin\rho\sin\gamma \\ \cos\rho
\end{pmatrix},
\end{align*}

\begin{align*}
\texttt{wishvel} &= \vec{\fmove} + \vec{\rmove} + \umove
\begin{pmatrix}
0\\0\\1
\end{pmatrix} =
\begin{pmatrix}
\fmove \cos\rho\cos\gamma + \rmove \sin\gamma\\
\fmove \cos\rho\sin\gamma - \rmove \cos\gamma\\
-\fmove \sin\rho + \umove
\end{pmatrix},\\
\vec{\fmove} + \vec{\rmove} + \vec{\umove} &=
\begin{pmatrix}
(\fmove \cos\rho + \umove \sin\rho)\cos\gamma + \rmove \sin\gamma\\
(\fmove \cos\rho + \umove \sin\rho)\sin\gamma - \rmove \cos\gamma\\
-\fmove \sin\rho + \umove \cos\rho
\end{pmatrix},
% = \frac{1}{\flat{v}}
%\begin{pmatrix}
%(\hphantom{-}\fmove v_x + \rmove v_y)\cos\delta + (\rmove v_x - \fmove v_y)\sin\delta\\
%(-\rmove v_x + \fmove v_y)\cos\delta + (\fmove v_x + \rmove v_y)\sin\delta\\
%0
%\end{pmatrix}
\end{align*}
\begin{align*}
\norm{\texttt{wishvel}} &= \sqrt{(\fmove \cos\rho)^2 + \rmove^2 + (-\fmove \sin\rho + \umove)^2} = \sqrt{\fmove^2 + \rmove^2 + \umove^2  - 2\fmove\umove\sin\rho},\\
\norm{\vec{\fmove} + \vec{\rmove} + \vec{\umove}} &= \sqrt{(\fmove \cos\rho + \umove \sin\rho)^2 + \rmove^2 + (-\fmove \sin\rho + \umove \cos\rho)^2} = \sqrt{\fmove^2 + \rmove^2 + \umove^2} = \norm{\vec{\cmd}},
\end{align*}
Using the law of cosines $\fumove^2 = \fmove^2 + \umove^2 - 2\fmove\umove\cos(\pi/2 - \rho)$
\begin{align*}
\norm{\texttt{wishvel}} &= \sqrt{\fumove^2 + \rmove^2},
\end{align*}

\begin{align*}
\texttt{wishdir} &= \uvec{a} = \frac{\texttt{wishvel}}{\norm{\texttt{wishvel}}} = \frac{1}{\sqrt{\fmove^2 + \rmove^2 + \umove^2  - 2\fmove\umove\sin\rho}}
\begin{pmatrix}
\fmove \cos\rho\cos\gamma + \rmove \sin\gamma\\
\fmove \cos\rho\sin\gamma - \rmove \cos\gamma\\
-\fmove \sin\rho + \umove
\end{pmatrix},
%\frac{\vec{\fmove} + \vec{\rmove} + \vec{\umove}}{\norm{\vec{\fmove} + \vec{\rmove} + \vec{\umove}}} &=
%%\frac{1}{\flat{\cmd} \flat{v}}
%%\begin{pmatrix}
%%(\hphantom{-}\fmove v_x + \rmove v_y)\cos\delta + (\rmove v_x - \fmove v_y)\sin\delta\\
%%(-\rmove v_x + \fmove v_y)\cos\delta + (\fmove v_x + \rmove v_y)\sin\delta\\
%%0
%%\end{pmatrix}
%\frac{1}{\cmd}
%\begin{pmatrix}
%(\fmove \cos\rho + \umove \sin\rho)\cos\gamma + \rmove \sin\gamma\\
%(\fmove \cos\rho + \umove \sin\rho)\sin\gamma - \rmove \cos\gamma\\
%-\fmove \sin\rho + \umove \cos\rho
%\end{pmatrix},
\end{align*}

\begin{align*}
\texttt{wishspeed} &= s = 320\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{\norm{\texttt{wishvel}}}{\norm{\vec{\cmd}}} = 320\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{\sqrt{\fmove^2 + \rmove^2 + \umove^2  - 2\fmove\umove\sin\rho}}{\norm{\vec{\cmd}}},\\
\norm{\vec{a}} &= a = sAT = 320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{\norm{\texttt{wishvel}}}{\norm{\vec{\cmd}}},
\end{align*}
with $A = 8$ (\texttt{pm\_flyaccelerate}).

However, in order to gain the full acceleration, $a$, we need the angle to be a bit larger, so we avoid the special case mentioned above. Therefore the optimal angle is the smallest angle at which we receive the full acceleration, $a$, which is given by
\begin{align*}
s(1-AT) = \vec{v}_f^T \uvec{a},\\
320\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{\cmd^2  - 2\fmove\umove\sin\rho}{\cmd}(1-AT) &= v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove)
\end{align*}

\begin{align}
\label{eq:ABCD}
A + B\sin\rho + C\sin\gamma + D\cos\rho\cos\gamma = 0,
\end{align}

\begin{align*}
S &= \frac{320\norm{\vec{\cmd}}_{\infty}(1-AT)}{127},\\
A &= S\cmd         - v_{fz}\umove,\\
B &= -\frac{2S}{\cmd}\fmove\umove + v_{fz}\fmove,\\
C &= -v_{fx}\rmove,\\
D &= -v_{fx}\fmove,
\end{align*}

\begin{verbatim}
tmp = D^2*cos(y)^2 - (A + C*sin(y) - B)*(A + C*sin(y) + B);
tmp(tmp < 0) = nan;
tmp1 = -2*atan2((B - sqrt(tmp)),(A + C*sin(y) - D*cos(y)));
tmp2 = -2*atan2((B + sqrt(tmp)),(A + C*sin(y) - D*cos(y)));
tmp1(tmp1 >  pi) = tmp1(tmp1 >  pi) - 2*pi;
tmp1(tmp1 < -pi) = tmp1(tmp1 < -pi) + 2*pi;
tmp2(tmp2 >  pi) = tmp2(tmp2 >  pi) - 2*pi;
tmp2(tmp2 < -pi) = tmp2(tmp2 < -pi) + 2*pi;
\end{verbatim}

\begin{align*}
\norm{\vec{v}_f + \norm{\vec{a}}\uvec{a}}^2 &= \norm{\vec{v}}^2,\\
2\vec{a}^T \vec{v}_f + \vec{a}^T \vec{a} &= \vec{v}^T \vec{v} - \vec{v}_f^T \vec{v}_f,\\
2\norm{\vec{a}} \vec{v}_f^T \uvec{a} + \norm{\vec{a}}^2 &= \norm{\vec{v}}^2 - \norm{\vec{v}_f}^2,\\
320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove) ) +\\
320^2 A^2 T^2\frac{\norm{\vec{\cmd}}^2_{\infty}}{127^2\hphantom{_{\infty}}} \frac{\cmd^2  - 2\fmove\umove\sin\rho}{\cmd^2} &= v_x^2 + v_z^2 - v_{fx}^2 - v_{fz}^2,
\end{align*}

\begin{align*}
S' &= \frac{320AT\norm{\vec{\cmd}}_{\infty}}{127} = \frac{320\norm{\vec{\cmd}}_{\infty}}{127} - S,\\
S &= \frac{320\norm{\vec{\cmd}}_{\infty}}{127} - S',\\
A' &= \hphantom{-}\frac{2S'}{\cmd}v_{fz}\umove + S'^2 - v_x^2 - v_z^2 + v_{fx}^2 + v_{fz}^2 = A - S\cmd + \left(\frac{2S'}{\cmd} + 1\right)v_{fz}\umove + S'^2 - v_x^2 - v_z^2 + v_{fx}^2 + v_{fz}^2,\\
B' &= -\frac{2S'}{\cmd}v_{fz}\fmove - \frac{2S'^2}{\cmd^2}\fmove\umove,\\
C' &= \hphantom{-}\frac{2S'}{\cmd}v_{fx}\rmove = -\frac{2S'}{\cmd}C,\\
D' &= \hphantom{-}\frac{2S'}{\cmd}v_{fx}\fmove = -\frac{2S'}{\cmd}D,
\end{align*}
\begin{align*}
S' &= \frac{320AT\norm{\vec{\cmd}}_{\infty}}{127},\\
S &= \frac{320\norm{\vec{\cmd}}_{\infty}}{127} - S',\\
-\frac{2S'}{\cmd}\\
A' &= -v_{fz}\umove - \frac{\cmd}{2S'}(S'^2 - v_x^2 - v_z^2 + v_{fx}^2 + v_{fz}^2),\\
B' &= -\frac{S'}{\cmd}\fmove\umove + v_{fz}\fmove,\\
C' &= -v_{fx}\rmove,\\
D' &= -v_{fx}\fmove,
\end{align*}

\begin{align*}
\frac{d}{d\rho}\norm{\vec{v}_f + \norm{\vec{a}}\uvec{a}}^2 &= 0,\\
\frac{d}{d\rho}2\vec{a}^T \vec{v}_f + \frac{d}{d\rho}\vec{a}^T \vec{a} &= 0,\\
\frac{d}{d\rho}2\norm{\vec{a}} \vec{v}_f^T \uvec{a} + \frac{d}{d\rho}\norm{\vec{a}}^2 &= 0,\\
\frac{d}{d\rho}320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove) ) +\\
\frac{d}{d\rho}320^2 A^2 T^2\frac{\norm{\vec{\cmd}}^2_{\infty}}{127^2\hphantom{_{\infty}}} \frac{\cmd^2  - 2\fmove\umove\sin\rho}{\cmd^2} &= 0,\\
%
\frac{d}{d\rho}320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}\fmove \cos\rho\cos\gamma - v_{fz}\fmove \sin\rho ) - \frac{d}{d\rho}320^2 A^2 T^2\frac{\norm{\vec{\cmd}}^2_{\infty}}{127^2\hphantom{_{\infty}}} \frac{2\fmove\umove}{\cmd^2}\sin\rho &= 0,\\
-320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}\fmove \sin\rho\cos\gamma + v_{fz}\fmove \cos\rho ) - 320^2 A^2 T^2\frac{\norm{\vec{\cmd}}^2_{\infty}}{127^2\hphantom{_{\infty}}} \frac{2\fmove\umove}{\cmd^2}\cos\rho &= 0,
\end{align*}

\begin{align*}
A\sin\rho\cos\gamma + B\cos\rho &= 0,
\end{align*}

\begin{align*}
S &= \frac{320AT\norm{\vec{\cmd}}_{\infty}}{127},\\
A &= -\frac{2S}{\cmd}v_{fx}\fmove,\\
B &= -\frac{2S}{\cmd}v_{fz}\fmove - \frac{2S^2}{\cmd^2}\fmove\umove,
\end{align*}

\begin{align*}
\frac{d}{d\rho}\norm{\vec{v}_f + \norm{\vec{a}}\uvec{a}}^2 &= 0,\\
\frac{d}{d\rho}2\vec{a}^T \vec{v}_f + \frac{d}{d\rho}\vec{a}^T \vec{a} &= 0,\\
\frac{d}{d\rho}2\norm{\vec{a}} \vec{v}_f^T \uvec{a} + \frac{d}{d\rho}\norm{\vec{a}}^2 &= 0,\\
\frac{d}{d\gamma}320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove) ) +\\
\frac{d}{d\gamma}320^2 A^2 T^2\frac{\norm{\vec{\cmd}}^2_{\infty}}{127^2\hphantom{_{\infty}}} \frac{\cmd^2  - 2\fmove\umove\sin\rho}{\cmd^2} &= 0,\\
%
\frac{d}{d\gamma}320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma)) &= 0,\\
-320AT\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{1}{\cmd}2 (v_{fx}(\fmove \cos\rho\sin\gamma - \rmove \cos\gamma)) &= 0,
\end{align*}

\begin{align*}
A\cos\rho\sin\gamma + B\cos\gamma &= 0,
\end{align*}

\begin{align*}
S &= \frac{320AT\norm{\vec{\cmd}}_{\infty}}{127},\\
A &= -\frac{2S}{\cmd}v_{fx}\fmove,\\
B &= \hphantom{-}\frac{2S}{\cmd}v_{fx}\rmove,
\end{align*}

\begin{align*}
B\cos\rho - D\sin\rho\cos\gamma &= 0,\\
C\cos\gamma - D\cos\rho\sin\gamma &= 0,
\end{align*}

Grey area:
\begin{align*}
s = \vec{v}_f^T \uvec{a},\\
320\frac{\norm{\vec{\cmd}}_{\infty}}{127\hphantom{_{\infty}}} \frac{\cmd^2  - 2\fmove\umove\sin\rho}{\cmd} &= v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove)
\end{align*}
\eqref{eq:ABCD}
\begin{align*}
S &= \frac{320\norm{\vec{\cmd}}_{\infty}}{127},\\
A &= S\cmd         - v_{fz}\umove,\\
B &= -\frac{2S}{\cmd}\fmove\umove + v_{fz}\fmove,\\
C &= -v_{fx}\rmove,\\
D &= -v_{fx}\fmove,
\end{align*}

\texttt{PM\_Accelerate (wishdir, wishspeed, pm\_flyaccelerate);}

\begin{align*}
\norm{\vec{v}_f + (s - \vec{v}_f^T \uvec{a})\uvec{a}}^2 &= \norm{\vec{v}}^2,\\
(\vec{v}_f + (s - \vec{v}_f^T \uvec{a})\uvec{a})^T (\vec{v}_f + (s - \vec{v}_f^T \uvec{a})\uvec{a}) &= \vec{v}^T \vec{v},\\
2(s - \vec{v}_f^T \uvec{a})\uvec{a}^T \vec{v}_f + (s - \vec{v}_f^T \uvec{a})^2\uvec{a}^T\uvec{a} &= \vec{v}^T \vec{v} - \vec{v}_f^T \vec{v}_f,\\
2(s - \vec{v}_f^T \uvec{a})\vec{v}_f^T \uvec{a} + (s - \vec{v}_f^T \uvec{a})^2 &= \norm{\vec{v}}^2 - \norm{\vec{v}_f}^2,\\
s^2 - \left(\vec{v}_f^T \uvec{a}\right)^2 &= v^2 - v_f^2,\\
320^2\frac{\norm{\vec{\cmd}}_{\infty}^2}{127^2\hphantom{_{\infty}}} \frac{(\cmd^2  - 2\fmove\umove\sin\rho)^2}{\cmd^2} -\\ (v_{fx}(\fmove \cos\rho\cos\gamma + \rmove \sin\gamma) + v_{fz}(-\fmove \sin\rho + \umove))^2 &= (v_x^2 + v_z^2 - v_{fx}^2 - v_{fz}^2) (\cmd^2  - 2\fmove\umove\sin\rho),
\end{align*}
which is too complex to calculate efficiently.
